<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="mapper">
  	<resultMap type="map" id="rsList">
  		<result column="SEQ" property="seq"/>
  		<result column="MEM_NAME" property="memName"/>
  		<result column="MEM_ID" property="memId"/>
  		<result column="BOARD_SUBJECT" property="boardSubject"/>
  		<result column="BOARD_CONTENT" property="boardContent"/>
  		<result column="VIEW_CNT" property="viewCnt"/>
  		<result column="REG_DATE" property="regDate"/>
  		<result column="UPT_DATE" property="uptDate"/>
  	</resultMap>
  	
  	<sql id="board_study">
  		SEQ AS seq
  		,MEM_NAME AS memName
  		,MEM_ID AS memId
  		,BOARD_SUBJECT AS boardSubject
  		,BOARD_CONTENT AS boardContent
  		,VIEW_CNT AS viewCnt
  		,REG_DATE AS regDate
  		,UPT_DATE AS uptDate
  	</sql>
  	
  	<!-- 게시글 검색 -->
    <sql id="search">
        <!-- 검색 키워드가 있을 때 -->
        <if test="keyword != null and keyword != ''">
            <choose>
<!--                 검색 유형이 있을 때 -->
                <when test="searchType != null and searchType != ''">
                    <choose>
                        <when test="'title'.equals( searchType )">
                            AND BOARD_SUBJECT LIKE '%'||#{keyword}||'%'
                        </when>
                        <when test="'content'.equals( searchType )">
                            AND BOARD_CONTENT LIKE '%'||#{keyword}||'%'
                        </when>
                        <when test="'writer'.equals( searchType )">
                            AND MEM_NAME LIKE '%'||#{keyword}||'%'
                        </when>
                    </choose>
                </when>
<!--                 전체 검색일 때 때 -->
                <otherwise>
                    AND (
                    BOARD_SUBJECT LIKE '%'||#{keyword}||'%'
                    OR BOARD_CONTENT LIKE '%'||#{keyword}||'%'
                    )
                </otherwise>
            </choose>
        </if>
        <!-- 날짜 검색이 있을 때 -->
        <if test="startDate != null and startDate != ''">
        	and to_char(reg_date, 'yyyy-MM-dd') between #{startDate} and #{endDate}
        </if>
    </sql>
  
  	<!-- 여기부터 결재시스템 쿼리문 -->
 	<select id="login" resultType="com.com.com.Authorization.VO.MemberVO">
  		SELECT ID AS id
  			 , USER_ID AS userId
  			 , USER_PW AS userPw
  			 , USER_NAME AS userName
  			 , USER_RANK AS userRank
		FROM sy_member
		WHERE 
			USER_ID = #{loginId}
  	</select>
  	
  	<select id="getList">
  		SELECT 
  	</select>
  
  
  	<!-- 여기부터 Board 게시판 쿼리문 -->
  
 	<select id="list" resultType="com.com.com.BoardVO.BoardResponse">
  		SELECT rn,
  			<include refid="board_study"/>
		FROM (
			select 
			row_number() over(order by SEQ desc) rn
			, bs.*
        	FROM board_study bs
        	WHERE 1=1 <include refid="search"/>
        	)
		WHERE  rn BETWEEN (#{pageNum} - 1) * #{amount} + 1 AND #{pageNum} * #{amount} 
  	</select>
  	
  	<select id="listTest" resultMap="rsList">
  		SELECT 
  		row_number() over(order by SEQ desc) rn
  		, bs.* 
  		FROM board_study bs
  		WHERE 1=1 <include refid="search"/>
  	</select>
  	
  	<select id="count" resultType="int">
  		SELECT 
  			count(*) 
		FROM board_study
  	</select>
  	
  	<select id="view" resultType="com.com.com.BoardVO.BoardResponse">
  		select
  			SEQ AS seq
			,MEM_NAME AS memName
			,MEM_ID AS memId
			,BOARD_SUBJECT AS boardSubject
			,BOARD_CONTENT AS boardContent
			,TO_CHAR(REG_DATE, 'YYYY-MM-DD HH24:MI:SS') AS regDate
			,TO_CHAR(UPT_DATE, 'YYYY-MM-DD HH24:MI:SS') AS uptDate
			,VIEW_CNT AS viewCnt
			,USEYN
		from board_study
		where 
			SEQ = #{seq}
  	</select>
  	
  	<select id="fileView" resultType="com.com.com.FileVO.FileResponse">
  		SELECT
  			FILE_SEQ AS fileSeq
  			,REAL_NAME AS fileName
  			,SAVE_NAME AS saveName
  			,REG_DATE AS regDate
  			,SAVE_PATH AS savePath
  			,LIST_SEQ AS listSeq
		FROM file_study_table
		WHERE LIST_SEQ = #{seq}
  	</select>
  	
  	<select id="nextSeq" resultType="int">
  		SELECT (NVL(MAX(seq),0)+1) AS seq FROM board_study
  	</select>
  	
  	<insert id="save">
  		insert INTO board_study(
  			SEQ
  			,MEM_NAME
			,MEM_ID
			,BOARD_SUBJECT
			,BOARD_CONTENT
			,REG_DATE
			,UPT_DATE
			,VIEW_CNT
			,USEYN
		)
		values(
			#{seq}
			,#{memName}
			,#{memId}
			,#{boardSubject}
			,#{boardContent}
			,sysdate
			,null
			,0
			,null
		)
  	</insert>
  	
  	<insert id="fileSave">
  		insert INTO FILE_STUDY_TABLE(
  			FILE_SEQ
  			,REAL_NAME
			,SAVE_NAME
			,REG_DATE
			,SAVE_PATH
			,LIST_SEQ
		)
		values(
  			(SELECT (NVL(MAX(FILE_SEQ),0)+1) FROM FILE_STUDY_TABLE)
  			,#{fileName}
			,#{saveName}
			,sysdate
			,#{savePath}
			,#{listSeq}
		)
  	</insert>
  	
  	<update id="update">
  		UPDATE board_study
  		SET
  			SEQ = #{seq}
  			,MEM_NAME = #{memName}
			,MEM_ID = #{memId}
			,BOARD_SUBJECT = #{boardSubject}
			,BOARD_CONTENT = #{boardContent}
			,UPT_DATE = sysdate
		WHERE
			SEQ = #{seq}
  	</update>
  	
  	<delete id="delete">
  		DELETE FROM board_study
  		WHERE
  			SEQ = #{seq}
  	</delete>
  	
  </mapper>